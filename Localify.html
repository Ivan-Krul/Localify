<!DOCTYPE html>
<html>

<head>
  <title>Localify</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<style>
  :root {
    --offset-playlist-size: 0px;
  }
  
  @font-face {
    font-family: "Roboto Medium";
    src: url("./Roboto-Medium.ttf");
  }

  @font-face {
    font-family: "Roboto Regular";
    src: url("./Roboto-Regular.ttf");
  }

  @font-face {
    font-family: "Roboto Light";
    src: url("./Roboto-Light.ttf");
  }

  body {
    background-color: #111;
    color: white;
    font-family: "Roboto Regular";
    font-size: small;
  }

  #title_container {
    background-color: #008000;
    text-align: center;
    font-size: 200%;
    padding: 10px;
    font-family: "Roboto Medium";
    border: none;
    border-radius: 10px;
    margin-bottom: 5px;
  }

  select,
  button {
    font-family: "Roboto Regular";
    margin: 2px;
    padding: 5px;
    padding-left: 10px;
    padding-right: 10px;
    border-radius: 10px;
    border: none;
  }

  label {
    font-family: "Roboto Light";
  }

  #player {
    width: 100%;
    margin-bottom: 10px;
    border: none;
    border-radius: 5px;
  }

  .recommend_container {
    width: 100%;
    background-color: #222;
  }
  
  .slider {
    vertical-align: middle;
  }

  .folder {
    background-color: #deb616;
    font-family: "Roboto Light";
    font-size: 1.5ch;
    padding-bottom: 1px;
    padding-top: 1px;
    padding-left: 2px;
    padding-right: 2px;
    color: black;
    border: none;
    border-radius: 2px;
  }

  .list tr {
    display: block;
    float: left;
    overflow-x: hidden;
  }

  .list td {
    display: block;
    padding-left: 0.5vw;
    padding-right: 0.5vw;
    padding-top: 0.25ch;
    padding-bottom: 0.25ch;
  }

  .list tr td:hover {
    background-color: #444;
  }

  .overlay {
    padding: 5px;
  }

  .recommend_overlay {
    margin: 5px;
    border: none;
    border-bottom-left-radius: 10px;
  }

  .scrollable {
    overflow-y: auto;
    overflow-x: hidden;
    margin-top: 5px;
    margin-bottom: 5px;
  }

  #playlist_container {
    height: calc(100% - (var(--offset-playlist-size) + 70px + 10ch));
    margin-top: 5px;
    margin-bottom: 5px;
  }

  .folder_overlay {
    margin: 5px;
    border: none;
  }

  #current_player_container {
    background-color: #333;
    margin-top: 5px;
    border: none;
    border-top-right-radius: 10px;
  }

  #equalizer_visualer {
    width: 100%;
    height: 30vh;
    border: none;
    border-top-right-radius: 5px;
    display: inherit;
  }

  .content_container {
    height: calc(100vh - 75px);
  }

  .checkbox {
    scale:150%;
    margin-right: 1ch;
  }

  .search {
    border: 1px solid grey;
    border-radius: 5px;
  }

  #search_music {
    width: 100%;
    margin-bottom: 5px;
  }

  @media screen and (max-aspect-ratio: 1/1) {
    #button_scrollUp {
      position: fixed;
      z-index: 1;
      bottom: 5%;
      right: 5%;
    }
    
    .list tr {
      width: calc(100vw - 30px);
    }
    
    .recommend_overlay {
      border-radius: 10px;
    }
    
    .folder_overlay {
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
    }
    
    #equalizer_visualer {
      border-top-left-radius: 5px;
    }
    
    #current_player_container {
      border-top-left-radius: 10px;
    }
  }

  @media screen and (min-aspect-ratio: 1/1) {
    #title_container {
      position: fixed;
      top: 10px;
      left: 10px;
      width: calc(100vw - 40px);
    }
  
    #button_scrollUp {
      display: none;
    }

    .overlay {
      position: fixed;
      right: 10px;
      height: calc(100vh - 90px);
      width: calc(50vw - 20px);
    }

    .recommend_overlay {
      position: fixed;
      left: 5px;
      height: calc(50vh - 20px);
      width: calc(50vw - 20px);
    }

    .folder_overlay {
      position: fixed;
      left: 5px;
      min-height: 10vh;
      max-height: calc(50vh - 70px);
      width: calc(50vw - 20px);
      border-top-left-radius: 10px;
    }

    .overlay {
      top: 70px;
    }

    .recommend_overlay {
      bottom: 0%;
    }

    .folder_overlay {
      top: 70px;
    }

    .list tr {
      width: calc(50vw - 20px - 25px);
    }
    
    #current_player_container {
      border-bottom-right-radius: 10px;
    }
  }
  
  #player_container {
    width: 100%;
    height: 40px;
    background-color: #1e1e1e;
    margin-bottom: 10px;
    border: none;
    border-radius: 5px;
  }
  
  #player_container * {
    justify-content: center;
  }
  
  #player_volume_slider {
    width: 70px;
  }
  
  #player_progress {
    width: calc(100% -  36ch);
  }
  
  #player_play_pause {
    margin-left: 10px;
  }
  
  #player_volume_slider {
    margin-right: 10px;
  }
  
  #playlist_placeholder {
    text-align: center;
    width: 100%;
    padding: 15vh 0;
    color: #555;
    font-size: 5vh;
  }
</style>

<body>
  <div id="title_container">
    <span>Localify</span>
  </div>
  <div class="content_container">
    <div id="current_player_container" class="overlay">
      <div>
        <canvas id="equalizer_visualer"></canvas>
        <div id="player_container">
          <div id="player_inner">
            <button id="player_play_pause">&gt;</button>
            <input type="range" id="player_progress" step="0.1" value="0" min="0" class="slider"></progress>
            <label for="player_progress" id="player_time">
              <span id="player_current_progress">0:00</span>
                <span style="color:gray;"> / 
                  <span id="player_progress_limit">0:00</span>
                </span>
              </label>
              
            <button id="player_volume_mute">V</button>
            <input type="range" id="player_volume_slider" name="volume" min="0" max="1" value="0.5" step="0.01" />
          </div>
        </div>
        <audio id="player"></audio>

        <div>
          <button id="button_previous">&lt;|</button>
          <button id="button_inPlaylist">\/</button>
          <button id="button_next">|&gt;</button>
          <button id="button_push">+ list</button>
          <button id="button_pop">- list</button>
          <button id="button_clear">clear list</button>
          <button id="button_chooseRandomly">random pick</button>
        </div>
        <details id="settings_container" style="background-color: #555; padding-top: 1ch; padding-bottom: 1ch">
          <summary>Settings</summary>
          <button id="button_downloadPlaylist">Download playlist (in content.txt)</button>
          <button id="refresh_list"><a href="powershell://D:/Web Pages/Localify/WritePathsToContent.ps1">Refresh list (uses specific URI protocol)</a></button>
          <div>
            <select id="select_eqRenderStage">
              <option value="full">Full res EQ</option>
              <option value="half">Half res EQ</option>
              <option value="fifth">Fifth res EQ</option>
              <option value="average x5">Average x5 res EQ</option>
              <option value="average 4">Average 4 res EQ</option>
              <option value="only 3">Only 3 res EQ</option>
              <option value="no">Without EQ</option>
            </select>
            <button id="button_recordEQ">Record EQ</button>
            <div><label for="number_delay">Frame rate for EQ:</label><input type="number" min="0" step="1" id="number_delay" style="width: 10ch"></div>
            <div><label for="number_frame_delay_mult">Delay multiplier (Input * EQ resolution) in ms:</label><input type="number" min="0.5" value="1" id="number_frame_delay_mult" style="width: 10ch"></div>
          <div><label for="color_baseColor">Base EQ color:</label><input type="color" value="#141414" id="color_baseColor"></div>
          <div><label for="color_colorShift">EQ secondary color:</label><input type="color" value="#404040" id="color_colorShift"></div>
        </div>
        </details>

        <div>
          <label for="name">Name:&ThickSpace;&ThickSpace;</label>
          <span id="name"></span>
        </div>

        <div>
          <label for="album">Album:&ThickSpace;&ThickSpace;</label>
          <span id="album"></span>
        </div>

      </div>
      <div id="playlist_container" class="scrollable">
        <div id="playlist_placeholder">Emply list</div>
        <table id="table_playlist_container" class="list">
        </table>
      </div>
    </div>
    <div>
      <div class="folder_overlay scrollable">
        <table id="table_folder_container" class="list recommend_container">
        </table>
      </div>
      <div class="recommend_overlay scrollable">
        <input type="search" id="search_music" class="search">
        <table id="table_recommend_container" class="list recommend_container">
        </table>
      </div>
    </div>

    <button id="button_scrollUp">Scroll up</button>
  </div>

  <script>
    // main tools
    function getRandomInt(max) {
      return Math.floor(Math.random() * max);
    }

    function readFromFileURL(fileURL) {
      return new Promise((resolve, reject) => {
      fetch(fileURL)
        .then(response => response.blob())
        .then(blob => {
          const reader = new FileReader();
          reader.onload = function (event) {
            const text = event.target.result;
            resolve(text);
          };
          reader.onerror = function (event) {
            console.error("Error reading file:", event.target.error);
            reject(event.target.error);
          };
          reader.readAsText(blob);
        })
        .catch(error => {
          console.error("Error:", error);
          reject(error);
        });
      });
    }

    function convertLinkToName(link = "") {
      let split = link.split(directorySeparation);
      const filename = split[split.length - 1];
      const dots = filename.split(".");
      if (dots[dots.length - 1] !== "m3u8" && dots[dots.length - 1] !== "m3u") {
        let name = "";
        for (let i = 0; i < dots.length - 1; i++)
          name += dots[i];

        return name;
      }
      else {
        console.log("list");
        return filename;
      }
    }

    function chopNameRaw(link = "", splitBy = '') {
      let split = link.split(splitBy);
      whatever = "";
      for (let index = 0; index < split.length - 1; index++) {
        const element = split[index];
        whatever += element + splitBy;
      }
      return whatever;
    }

    function chopLocDirRaw(link = "", splitBy = '') {
      let split = link.split(splitBy);
      return split[split.length - 2];
    }
    
    function getSharedFolders(list = []) {
      let sharedFolderList = [];
      
      
      
    }
    
    function chopNameHTML(link = "", splitBy = '') {
      let split = link.split(splitBy);
      whatever = "";
      for (let index = 0; index < split.length - 1; index++) {
        const element = split[index];
        if (element !== ".." && element !== ".")
          whatever += "<span class=\"folder\">" + element + "</span> ";
      }
      return whatever;
    }

    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: "smooth"
      });
    }

    function scrollToBottom() {
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: "smooth"
      });
    }

		function arraysEqual(a, b) {
			if (a === b) return true;
			if (a == null || b == null) return false;
			if (a.length !== b.length) return false;
			
			for (var i = 0; i < a.length; ++i) {
				if (a[i] !== b[i]) return false;
			}
			return true;
		}


    // predecl
    // render equalizer visualiser
    // sources: https://codepen.io/nfj525/pen/rVBaab -> "JS Audio Visualizer" by "Nick Jones"
    function Equalizer() {
      this.context = new AudioContext();
      this.player = document.getElementById("player");
      this.src = this.context.createMediaElementSource(this.player);
      this.analyser = this.context.createAnalyser();

      this.eq_visualizer = document.getElementById("equalizer_visualer");
      this.eq_visualizer.width = window.innerWidth;
      this.eq_visualizer.height = window.innerHeight;
      this.canvasContext = this.eq_visualizer.getContext("2d");

      this.src.connect(this.analyser);
      this.analyser.connect(this.context.destination);

      this.analyser.fftSize = 256;

      this.bufferLength = this.analyser.frequencyBinCount;
      console.log("buffer length: " + this.bufferLength);

      this.dataArray = new Uint8Array(this.bufferLength);

      this.WIDTH = this.eq_visualizer.width;
      this.HEIGHT = this.eq_visualizer.height;

      this.barWidth = (this.WIDTH / this.bufferLength) * 1.25;
      this.barHeight;
      this.x = 0;
      this.req = null;
      this.render = false;
      this.scaleX = this.eq_visualizer.offsetWidth;
      this.scaleY = this.eq_visualizer.offsetHeight;
			
			this.prevDataArray = new Uint8Array(this.bufferLength);
			this.repeats = false;
      this.repeatCount = 0;

      this.baseColorFrom = {r: 20, g: 20, b: 20};
      this.baseColorTo = {r: 255, g: 255, b: 255};

      this.delay = undefined;
			this.colomnWidth = 1;
			this.delayMult = 1;

      this.ondebugshowing = (event) => {};
      this.externalAudio = null;
			
			this.canvasContext.fillStyle = "#000";
      this.canvasContext.fillRect(0, 0, this.WIDTH, this.HEIGHT);
    }

    Equalizer.prototype.getAnimationRequester = function () {
      return this.req;
    }

    Equalizer.prototype.startFrame = function (collect = true) {
      this.x = 0;
			
			for(let i = 0; i < this.dataArray.length; i++) {
				this.prevDataArray[i] = this.dataArray[i];
			}
			
      if (collect)
        this.analyser.getByteFrequencyData(this.dataArray);

			this.repeats = arraysEqual(this.dataArray,this.prevDataArray);

			if(this.repeats) {this.repeatCount++; return;}
			
      this.repeatCount = 0;
      
      this.canvasContext.fillStyle = "#000";
      this.canvasContext.fillRect(0, 0, this.WIDTH, this.HEIGHT);
    };

    Equalizer.prototype.colorCanvasRectange = function (width) {
			this.colomnWidth = width;
      var fraq = (this.barHeight / 256.0);

      var r = fraq * (this.baseColorTo.r - this.baseColorFrom.r) + this.baseColorFrom.r;
      var g = fraq * (this.baseColorTo.g - this.baseColorFrom.g) + this.baseColorFrom.g;
      var b = fraq * (this.baseColorTo.b - this.baseColorFrom.b) + this.baseColorFrom.b;
      const amplitude = 3.5;

      let bh = fraq * this.HEIGHT;

      if(this.HEIGHT - bh < 0)
        console.log(this.HEIGHT - bh);

      this.canvasContext.fillStyle = "rgb(" + r + "," + g + "," + b + ")";
      this.canvasContext.fillRect(this.x, this.HEIGHT - bh, this.barWidth * width, bh);

      this.x += this.barWidth * width - 1;
    };

    Equalizer.prototype.renderFullFrame = function () {
      this.startFrame();
			if(this.repeats) return;

      for (let i = 0; i < this.bufferLength * 0.8; i++) {
        this.barHeight = this.dataArray[i];
        this.colorCanvasRectange(1);
      }
    };

    Equalizer.prototype.renderSemiFrame = function () {
      this.startFrame();
			if(this.repeats) return;

      for (let i = 0; i < this.bufferLength * 0.8; i += 2) {
        this.barHeight = this.dataArray[i];
        this.colorCanvasRectange(2);
      }
    };

    Equalizer.prototype.renderFifthFrame = function () {
      this.startFrame();
			if(this.repeats) return;

      for (let i = 0; i < this.bufferLength * 0.8; i += 5) {
        this.barHeight = this.dataArray[i];
        this.colorCanvasRectange(5);
      }
    };

    Equalizer.prototype.renderWaveFrame = function () {
      this.startFrame();
			if(this.repeats) return;

      for (let i = 0; i < this.bufferLength * 0.8; i += 5) {
        this.barHeight = this.dataArray[i];
        this.colorCanvasRectange(5);
      }
    };

    Equalizer.prototype.renderAverageX5Frame = function () {
      this.startFrame();
			if(this.repeats) return;

      for (let i = 0; i < this.bufferLength * 0.8; i++) {
        this.barHeight += this.dataArray[i];
        if (i % 5 === 4) {
          this.barHeight /= 5;
          this.colorCanvasRectange(5);
          this.barHeight = 0;
        }
      }
    };
    Equalizer.prototype.renderAverage4Frame = function () {
      this.startFrame();
			if(this.repeats) return;

      var count = 0;

      const border = 1;
      var currentBorder = border;
      this.barHeight = 0;

      for (let i = 0; i < this.bufferLength * 0.8; i++) {
        if (i < currentBorder && (i + 1) < this.bufferLength * 0.8) {
          this.barHeight += this.dataArray[i];
          count++;
        }
        else {
          this.barHeight /= count;
          count = 0;
          this.colorCanvasRectange(Math.floor(this.bufferLength * 0.8 / 4));
          currentBorder = border + currentBorder * 5;
          this.barHeight = 0;
        }

      }
    };


    Equalizer.prototype.renderOnly3Frame = function () {
      this.startFrame();
			if(this.repeats) return;

      this.barHeight = this.dataArray[0];
      this.colorCanvasRectange(Math.floor(this.bufferLength * 0.8 / 3));
      this.barHeight = this.dataArray[3];
      this.colorCanvasRectange(Math.floor(this.bufferLength * 0.8 / 3));
      this.barHeight = this.dataArray[32];
      this.colorCanvasRectange(Math.floor(this.bufferLength * 0.8 / 3));
    };

    Equalizer.prototype.unpinAnimation = function () {
      this.startFrame(false);
      this.render = false;
    };
    Equalizer.prototype.pinAnimation = function () {
      this.render = true;
    };
    Equalizer.prototype.playExternal = function () {
      const playSound = this.context.createBufferSource();
      playSound.buffer = this.externalAudio;
      playSound.connect(this.context.destination);
      playSound.start(this.context.currentTime);
    }
    Equalizer.prototype.doRecord = function(self) {
      if (!eqRecord) return;
      
      let time = Intl.NumberFormat("en", {minimumFractionDigits:4}).format(self.player.currentTime);
      arrauEqRecord.push([time]);
      for(let i = 0; i < self.bufferLength; i++)
        arrauEqRecord[arrauEqRecord.length - 1].push(self.dataArray[i]);
    }
    Equalizer.prototype.doFrame = function(self) {
      switch (document.getElementById("select_eqRenderStage").value) {
      case "full":
        self.renderFullFrame();
        break;
      case "half":
        self.renderSemiFrame();
        break;
      case "fifth":
        self.renderFifthFrame();
        break;
      case "wave":
        self.renderWaveFrame();
        break;
      case "average x5":
        self.renderAverageX5Frame();
        break;
      case "average 4":
        self.renderAverage4Frame();
        break;
      case "only 3":
        self.renderOnly3Frame();
        break;
      case "no":
      default:
        self.unpinAnimation();
        break;
      }
    }
    Equalizer.prototype.checkStage = function () {
      //requestAnimationFrame(Equalizer.prototype.checkStage);
      const self = this;
      const incheckStage = () => {
        self.scaleX = self.eq_visualizer.offsetWidth / 912;
        self.scaleY = self.eq_visualizer.offsetHeight / 276;
        self.doRecord(self);
        self.doFrame(self);
        
        if (!self.render) return;
        
        if(self.delay !== 0 && self.delay != Infinity) 
          setTimeout(function() {self.req = requestAnimationFrame(incheckStage);}, self.delay);
        else if(self.repeats)
          setTimeout(function() {self.req = requestAnimationFrame(incheckStage);}, Math.min(self.repeatCount + 25,200));
        else
          setTimeout(function() {self.req = requestAnimationFrame(incheckStage);}, self.colomnWidth * self.delayMult);
      }

      incheckStage();
    };
    
    
    // custom player
    // own made
    function CustomPlayer() {
      this.player            = document.getElementById("player");
      this.playerContainer   = document.getElementById("player_container"); 
      this.playerTime        = document.getElementById("player_time");
      this.progressPlay      = document.getElementById("player_progress");
      this.buttonPlayPause   = document.getElementById("player_play_pause");
      this.numberCurrentTime = document.getElementById("player_current_progress");
      this.numberLimitTime   = document.getElementById("player_progress_limit");
      this.buttonMute        = document.getElementById("player_volume_mute");
      this.sliderVolume      = document.getElementById("player_volume_slider");
      
      this.threadProgressInterval = setInterval(() => {
        this.progressPlay.value = this.player.currentTime;
        this.progressPlay.max = this.player.duration;
        if(this.player.duration !== Math.NaN) {
          this.numberCurrentTime.innerText = parseInt(this.player.currentTime / 60)+ ":" + ('0' + parseInt(this.player.currentTime % 60)).slice(-2);
          this.numberLimitTime.innerText   = parseInt(this.player.duration    / 60)+ ":" + ('0' + parseInt(this.player.duration    % 60)).slice(-2);
        }
        else {
          this.numberCurrentTime.innerText = "0:00";
          this.numberLimitTime.innerText   = "0:00";
        }
      }, 200);
      
      this.progressPlay.onchange = (event) => {
        this.player.currentTime = event.target.value;
      };
      
      this.player.onplay = () => {
        this.buttonPlayPause.innerText = "||";
      }
      
      this.player.onpause = () => {
        this.buttonPlayPause.innerText = ">";
      }
      
      this.buttonPlayPause.onclick = () => {
        if(this.player.paused)
          this.player.play();
        else
          this.player.pause();
      };
      
      this.playerTime.onclick = this.buttonPlayPause.onclick;
      
      this.buttonMute.onclick = () => {
        this.player.muted = !this.player.muted;
        this.buttonMute.innerText = (this.player.muted) ? "M" : "V";
      };
    }


    // globals
    var current = 0
    var foldLoadFormat = false;
    var globalList = [];
    var folderList = [];
    var playlist = [];
    var selected = 0;
    var equalizer = new Equalizer();
    var customPlayer = new CustomPlayer();
    var eqRecord = false;
    var arrauEqRecord = [];

    const inWebMode = true;

    const directorySeparation = '/';

    // player
    function isInPlaylist() {
      return current === -1;
    }
    
    async function getListM3U8(link = "") {
      let list = ((await readFromFileURL(link)).split('\n')).filter((value) => { return value[0] !== '#' && value; });
      let finalList = [];
      for (let i = 0; i < list.length; i++)
        finalList.push(((list[i].indexOf("http") !== 0) ? chopNameRaw(link, directorySeparation) : "") + list[i]);
      return finalList;
    }

    function downloadMedia(link) {
      return new Promise((resolve, reject) => {
        console.log(link);
        const xhr = new XMLHttpRequest();
        xhr.open('GET', link, true);
        xhr.responseType = 'blob';
        
        xhr.onload = function() {
          if (xhr.status === 200) {
            resolve(xhr.response);
          } else {
            reject(new Error('Failed to download media (not 200)'));
          }
        };
  
        xhr.onerror = function() {
          reject(new Error('Failed to download media'));
        };
        
        xhr.send();
      });
    }

    function separateDomain(path = "") {
      return (/(?:http(s)?:\/\/)[\w\.]+/).exec(path)[0];
    }

    async function setMusicToPlay() {
      if(eqRecord)
        handleEndRecords();

      let set = getCurrentMusicLink();

      console.log(set);
      let player = document.getElementById("player");
      let name = document.getElementById("name");
      let album = document.getElementById("album");

      if(set.indexOf("http") === 0) {
        // http handle
        await downloadMedia(set)
          .then(data => data.arrayBuffer())
          .then(arrayBuffer => equalizer.context.decodeAudioData(arrayBuffer))
          .then(decodedAudio => { this.externalAudio = decodedAudio; });
        equalizer.playExternal();
      }
      else {
        // local handle
        player.src = set;
        name.innerText = convertLinkToName(set);
        album.innerHTML = chopNameHTML(set, directorySeparation);
      }
    }

    async function selectMusicToPlay() {
      if (!isInPlaylist()) { // because of safety
        if (globalList[current].match(/.*\.m3u(|8)/)) { // list
          console.log("list");
          playlist = await getListM3U8(globalList[current]);
          selected = 0;
          outputPlaylist(playlist);
        }
        else {
          await setMusicToPlay();
          pushToList();
        }
      }
      else
        await setMusicToPlay();
    }
    function nextMusic(player) {
      if (selected !== -1)
        selected++;
      if (selected < playlist.length && selected !== -1) {
        selectMusicToPlay(playlist[selected]);
        equalizer.context.resume();
        customPlayer.buttonPlayPause.onclick();
      }
    }
    function getCurrentMusicLink() {
      return isInPlaylist() ? playlist[selected] : globalList[current];
    }
    function setVolume() {
      if (localStorage.getItem("volume")) {
        document.getElementById("player_volume_slider").value = localStorage.getItem("volume");
        document.getElementById("player").volume = localStorage.getItem("volume") * localStorage.getItem("volume");
      }
    }
    function handleChangedVolumeCommonPlayer(player) {
      let playerVolume = player.target.value;
      localStorage.setItem("volume", playerVolume);
      setVolume();
    }
    function handleChangedVolumeBuildInPlayer(player) {
      let playerVolume = player.target.volume;
      localStorage.setItem("volume", playerVolume);
      setVolume();
    }
    function forcePlay() {
      selectMusicToPlay();
      equalizer.context.resume();
      customPlayer.buttonPlayPause.onclick();
    }
    
    document.getElementById("player_volume_slider").onchange = handleChangedVolumeCommonPlayer;
    document.getElementById("player").onended = nextMusic;
    document.onplaying = equalizer.checkStage;

    // choose randomly
    function selectRandomMusic() {
      let table = document.getElementById("table_recommend_container");
      table.children[0].children[getRandomInt(table.children[0].children.length)].click();
    }
    document.getElementById("button_chooseRandomly").onclick = selectRandomMusic;

    // eqRenderStage
    function showCanvas() {
      document.getElementById("equalizer_visualer").style.display = "inherit";
      equalizer.pinAnimation();
    }
    function hideCanvas() {
      document.getElementById("equalizer_visualer").style.display = "none";
    }
    function initSelectorEQ() {
      let stage = localStorage.getItem("EQ_render_mode");
      let target = document.getElementById("select_eqRenderStage");
      if (stage === undefined) {
        target.value = "no";
        localStorage.setItem("EQ_render_mode", "no");
        hideCanvas();
      }
      else {
        if (stage !== "no")
          showCanvas();
        else
          hideCanvas();
        target.value = stage;
      }
    }
    function checkStatus(target) {
      let val = target.target.value;
      localStorage.setItem("EQ_render_mode", val);
      if (val !== "no" && !equalizer.render) {
        showCanvas();
        equalizer.checkStage();
      }
      else if (equalizer.render && val === "no")
        hideCanvas();
    }
    document.getElementById("select_eqRenderStage").onchange = checkStatus;


    // next
    document.getElementById("button_next").onclick = nextMusic;

    // previous
    function previousMusic(player) {
      if (selected !== -1)
        selected--;
      if (selected >= 0 && selected !== -1) {
        selectMusicToPlay(playlist[selected]);
        equalizer.context.resume();
        document.getElementById("player").play();
      }
    }
    document.getElementById("button_previous").onclick = previousMusic;

    // get to list 
    function getToList() {
      selected = 0;
      current = -1;
      
      forcePlay();
    }
    document.getElementById("button_inPlaylist").onclick = getToList;

    // push to list
    function pushToList() {
      playlist.push(globalList[current]);
      outputPlaylist(playlist);
    }
    document.getElementById("button_push").onclick = pushToList;

    // pop from list
    function popFromList() {
      playlist.splice(selected, 1);
      outputPlaylist(playlist);
    }
    document.getElementById("button_pop").onclick = popFromList;

    // clear list
    function clearList() {
      playlist = [];
      selected = -1;
      outputPlaylist(playlist);
    }
    document.getElementById("button_clear").onclick = clearList;

    // download playlist
    function getSongDurations(songLinks) {
      let totalDuration = [];
      let promises = [];

      songLinks.forEach(link => {
        if (inWebMode)
          totalDuration.push(5);
        else {
          let audio = new Audio();

          audio.src = link;

          let promise = new Promise((resolve, reject) => {
            audio.onloadedmetadata = () => {
              totalDuration.push(audio.duration);
              resolve();
            };

            audio.onerror = () => reject(`Error loading ${link}`);
          });

          promises.push(promise);

          audio.load();
        }
      });

      return Promise.all(promises).then(() => {
        return totalDuration;
      });
    }
    function convertMusicLinkToWeb(pathMusic = "") {
      let path = window.location.href;

      let slash = path.lastIndexOf('/');
      if (slash === path.length - 1) {
        path = path.substring(0, slash);
        slash = path.lastIndexOf('/');
      }

      path = path.substring(0, slash);

      let dot = pathMusic.indexOf("./");

      if (dot !== -1 && dot === 0) {
        pathMusic = pathMusic.substring(3);
      }

      let dotdot = pathMusic.indexOf("../");
      while (dotdot !== -1) {
        slash = path.lastIndexOf('/');
        path = path.substring(0, slash);

        pathMusic = pathMusic.substring(dotdot + 3);
        dotdot = pathMusic.indexOf("../");
      }
      return `${path}/${pathMusic}`;
    }
    function writeRowM3U8(totalDuration) {
      let res = "";
      for (let i = 0; i < playlist.length; i++)
        res += `#EXFINF:${Math.ceil(totalDuration[i])},${chopLocDirRaw(playlist[i], directorySeparation)} - ${convertLinkToName(playlist[i])}\n${inWebMode ? convertMusicLinkToWeb(playlist[i]) : playlist[i]}\n`;
      return res;
    }
    function formM3U8() {
      let resFile = "#EXTM3U\n";
      let leng = [];

      return getSongDurations(playlist)
      .then(totalDuration => {
        resFile += writeRowM3U8(totalDuration);

        return resFile;
      })
      .catch(error => {
        throw error;
      });
    }

    function downloadPlaylist() {
      formM3U8()
      .then(str => {
        const blob = new Blob([str], { type: "text/plain" });

        const downloadLink = document.createElement("a");
        downloadLink.href = window.URL.createObjectURL(blob);
        downloadLink.download = `playlist.m3u${inWebMode ? "" : "8"}`; // Specify the downloaded file name
        downloadLink.click();
      })
      .catch(error => {
        console.error(error);
      });
    }
    document.getElementById("button_downloadPlaylist").onclick = downloadPlaylist;

    // record EQ
    function handleEndRecords() {
      eqRecord = false;
      document.getElementById("player").onended = nextMusic;
      console.log("ending recording...");

      const downloadLink = document.createElement('a');

      let str = "";

      for (let i = 0; i < arrauEqRecord.length; i++) {
        for (let j = 0; j < arrauEqRecord[i].length; j++)
          str += (j < arrauEqRecord[i].length - 1) ? `${arrauEqRecord[i][j]}\t` : arrauEqRecord[i][j];
        str += "\n";
      }

      arrauEqRecord = [];
      let blob = new Blob([str], {type:"text/text"});
      downloadLink.href = URL.createObjectURL(blob);
      downloadLink.download = `${convertLinkToName(globalList[current], directorySeparation)} EQList.txt`;
      downloadLink.click();
      URL.revokeObjectURL(blob);
    }
    function startRecordingEQ() {
      if(!confirm("You sure? (recording of equalizer would take storage and performance)")) return;
      
      document.getElementById("player").onended = handleEndRecords;
      console.log("recording...");
      arrauEqRecord = [];
      eqRecord = true;
      document.getElementById("player").currentTime = 0;
      document.getElementById("player").play();
    }
    document.getElementById("button_recordEQ").onclick = startRecordingEQ;

    // folders
    function createFolderList() {
      for (let i = 0; i < globalList.length; i++) {
        let chopped = chopNameRaw(globalList[i], directorySeparation);

        if (folderList.findIndex((sth) => chopped === sth) === -1)
          folderList.push(chopped);
      }
    }

    // table
    function setTable(rows, instance) {
      let tableRec = instance;

      let tr = document.createElement("tr");
      for (let j = 0; j < rows; j++) {
        let td = document.createElement("td");
        td.onclick = handleClickToCell;
        tr.append(td);
      }
      tableRec.append(tr);

      let tablePl = document.getElementById("table_playlist_container");

      tr = document.createElement("tr");
      for (let j = 0; j < rows; j++) {
        let td = document.createElement("td");
        td.onclick = handleClickToCell;
        tr.append(td);
      }
      tablePl.append(tr);
    }
    function handleClickToCell(event) {
      if (event.target.index !== undefined) {
        selected = event.target.index;
        current = -1;
      }
      else {
        current = event.target.value;
        selected = -1;
      }

      forcePlay();
    }
    function selectElementsAndOutputIndexes(list, searchString, toLowerCase = false) {
      const indexes = [];
      list.forEach((element, index) => {
        if ((toLowerCase ? element.toLowerCase() : element).indexOf((toLowerCase ? searchString.toLowerCase() : searchString)) !== -1)
          indexes.push(index);
      });
      return indexes;
    }
    function handleClickFolder(event) {
      let folder = folderList[event.target.value];
      let foldList = globalList.filter((sth) => { return sth.includes(folder) });

      outputPartionRecommends(foldList, selectElementsAndOutputIndexes(globalList, folder));
    }
    function foldAllFolders(list = []) {
      let table = document.getElementById("table_folder_container");
      let colomn = table.getElementsByTagName("tr")[0];
      colomn.innerHTML = "";

      for (let i = 0; i < list.length; i++) {
        let td = document.createElement("td");
        td.onclick = handleClickFolder;
        td.innerHTML = chopNameHTML(list[i], directorySeparation);
        td.value = i;
        colomn.append(td);
      }
    }
    function outputPartionRecommends(list = [], indexes = []) {
      let table = document.getElementById("table_recommend_container");
      let colomn = table.getElementsByTagName("tr")[0];
      colomn.innerHTML = "";

      for (let i = 0; i < list.length; i++) {
        let td = document.createElement("td");
        td.onclick = handleClickToCell;
        td.innerHTML = chopNameHTML(list[i], directorySeparation) + convertLinkToName(list[i]);
        td.value = indexes[i];
        colomn.append(td);
      }
    }
    function outputRecommends(list = []) {
      let table = document.getElementById("table_recommend_container");
      let colomn = table.getElementsByTagName("tr")[0];
      colomn.innerHTML = "";

      for (let i = 0; i < list.length; i++) {
        let td = document.createElement("td");
        td.onclick = handleClickToCell;
        td.innerHTML = chopNameHTML(list[i], directorySeparation) + convertLinkToName(list[i]);
        td.value = i;
        colomn.append(td);
      }
    }
    function outputPlaylist(list = []) {
      document.getElementById("playlist_placeholder").style.display = (list.length === 0) ? "inherit" : "none";

      let table = document.getElementById("table_playlist_container");
      let colomn = table.getElementsByTagName("tr")[0];
      colomn.innerHTML = "";

      for (let i = 0; i < list.length; i++) {
        let td = document.createElement("td");
        td.onclick = handleClickToCell;
        td.classList.add("playlist");
        td.innerHTML = chopNameHTML(list[i], directorySeparation) + convertLinkToName(list[i]);
        td.index = i;
        colomn.append(td);
      }
    }

    // scroll up
    document.getElementById("button_scrollUp").onclick = scrollToTop;

    // search bar
    function searchMusicByName(target) {
      if(target.target.value === "") return;

      let list = globalList.filter((elem) => {return (elem.toLowerCase()).includes(target.target.value.toLowerCase());});
      
      outputPartionRecommends(list, selectElementsAndOutputIndexes(globalList, target.target.value, true));
    }
    document.getElementById("search_music").oninput = searchMusicByName;

    // key binding
    /*document.addEventListener('keypress', e => {
      if (e.which === ' '.charCodeAt(0)) {
        if(document.getElementById("player").paused)
          document.getElementById("player").play();
        else
          document.getElementById("player").pause();
      }
    });*/

    // color settings from localStorage
    function hexToRgb(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
      } : null;
    }

    function rgbToHex(rgb) {
      return "#" + (1 << 24 | rgb.r << 16 | rgb.g << 8 | rgb.b).toString(16).slice(1);
    }

    function getColorFromLocalStorage() {
      let colorSettings = {};
      if (localStorage.getItem("colors_for_EQ"))
        colorSettings = JSON.parse(localStorage.getItem("colors_for_EQ"));
      else return;

      if(colorSettings.colorShift === null)
        colorSettings.colorShift = "#000000";

      let normBaseColor = hexToRgb(colorSettings.baseColor);
      let normShift  = hexToRgb(colorSettings.colorShift);

      equalizer.baseColorFrom = normBaseColor;
      equalizer.baseColorTo   = normShift;

      document.getElementById("color_baseColor").value = colorSettings.baseColor;
      document.getElementById("color_colorShift").value = colorSettings.colorShift;
    }

    function handleColorPick() {
      let colorSettings = {};

      colorSettings.baseColor = document.getElementById("color_baseColor").value;
      colorSettings.colorShift = document.getElementById("color_colorShift").value;

      let normBase = hexToRgb(colorSettings.baseColor);
      let normShift = hexToRgb(colorSettings.colorShift);

      equalizer.baseColorFrom = normBase;
      equalizer.baseColorTo   = normShift;

      localStorage.setItem("colors_for_EQ", JSON.stringify(colorSettings));
    }
    document.getElementById("color_baseColor").onchange = handleColorPick;
    document.getElementById("color_colorShift").onchange = handleColorPick;

    // EQ frame delay
    function changeFrameRate(event) {
      forceChangeFrameRate(event.target.value);
    }
    function forceChangeFrameRate(framerate) {
      equalizer.delay = 1000/framerate;
    }
    document.getElementById("number_delay").onchange = changeFrameRate;

		// EQ delay multiplier
		function changeDelayMultiplier(event) {
			equalizer.delayMult = parseFloat(event.target.value)
		}
		document.getElementById("number_frame_delay_mult").onchange = changeDelayMultiplier;

    // end
    (async () => {
      globalList = (await readFromFileURL("./content.txt"))
        .split("\n")
        .filter(function (element) {
          return element;
        });

      setTable(0, document.getElementById("table_recommend_container"));
      setTable(0, document.getElementById("table_folder_container"));
      createFolderList();
      setVolume();
      getColorFromLocalStorage();
      initSelectorEQ();
      equalizer.checkStage();
      foldAllFolders(folderList);
      outputRecommends(globalList);
      forceChangeFrameRate(document.getElementById("number_delay").value);
    })();
  </script>

</body>

</html>